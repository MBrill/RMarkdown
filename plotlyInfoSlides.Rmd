---
title: "Visualisierungen mit plotly"
author: "Manfred Brill"
encoding: utf-8
output: 
   slidy_presentation:
      highlight: pygments
      footer: "Visualisierungen mit plotly"
bibliography: literatur.bib
---

```{r setup, include=TRUE, echo=FALSE, message=FALSE, warnings=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(warn=-1)
# Rmd bearbeiten
library(knitr, warn.conflicts = FALSE, quietly=TRUE)
library(kableExtra, quietly=TRUE)
# Pipelines und mehr in Tidyverse
library(tidyverse, warn.conflicts = FALSE, quietly=TRUE)
# plotly
library(plotly, quietly=TRUE)
# Farbpaletten
library(RColorBrewer, quietly=TRUE)
myPalette <- brewer.pal(5, "YlGn")
# Ausgabe von double-Werte mit  zwei Stellen hinter dem Komma
options(digits=3)
options(warn=0)
```


```{r daten, message=FALSE, echo=FALSE}
liefer <- read_csv2("data/lieferzeiten.csv", show_col_types = FALSE)

frauen <- read_csv2("data/koerpergroesse_frauen.csv", show_col_types = FALSE)

wassergehalt <- read_csv2("data/wassergehalt.csv", show_col_types = FALSE)
```

# Übersicht über plotly
- plotly implementiert wie ggplot die *grammar of graphics* [@wilkinson_05]. 
- Wir setzen die Funktion *plot_ly* ein
- Oder wir erstellen mit *ggplot* eine Abbildung und verwenden *ggplotly*.
- plotly verwendet das Package *htmlwidgets*.
- Gute Einführung: [@sievert_19]

# Bemerkung
Auf den folgenden Folien ist immer ein Layout mit einer Angabe für die Größe der Abbildung zu sehen. Dies dient nur der besseren Dartellung auf den Folien und könnte auch weggelassen werden.

# ggplot und ggplotly

```{r first, message=FALSE, echo=TRUE, warning=FALSE}
plot <- ggplot(liefer) + 
    geom_bar(mapping=aes(x=Lieferzeiten))

ggplotly(plot) %>%
  layout(autosize=FALSE, width=400, height=400)
```

# Noch ein Beispiel für ggplot und ggplotly

```{r bars5, message=FALSE, results='markup', warning=FALSE}
plot <- ggplot(liefer) +
  geom_bar(mapping=aes(x=Lieferzeiten, y = ..prop..), 
           fill=myPalette[3]) +
  scale_x_discrete(limits=c(1,2,3,4,5,6,7)) +
  labs(title="Relative Häufigkeiten der Lieferzeiten", 
       x="Tage", y="Anteile in Prozent") +
  coord_flip()

ggplotly(plot) %>%
  layout(autosize=FALSE, width=400, height=400)
```

# Balkendiagramme

Geben wir nicht an welche Visualisierung wir verwenden möchten übernimmt
plotly die Entscheidung.

```{r liefer1, , message=FALSE, results='markup'}
plot_ly(liefer, 
        x = ~Lieferzeiten, 
        width=400, height=400) 
```

# Veränderung der Abbildung

```{r liefer2, message=FALSE, results='markup', warning=FALSE}
plot_ly(liefer, 
        x = ~Lieferzeiten, 
        color=myPalette[2],  
        width=400, height=400)
```


# Füllfarbe und Umriss

```{r liefer3, message=FALSE, results='markup', warning=FALSE}
plot_ly(
  liefer, 
  x = ~Lieferzeiten, 
  color=myPalette[2],
  stroke = I("black"),
  width=400, height=400)
```


# Titel mit der Funktion layout

```{r liefer4, message=FALSE, results='markup', warning=FALSE}
layout(
  plot_ly(
    liefer, 
    x = ~Lieferzeiten, 
    color=myPalette[2],
    stroke = I("black"), width=400, height=400),
  title = "Der Datensatz Lieferzeiten"
)
```

# Die Funktion plot_ly in einer Pipeline

```{r liefer5, message=FALSE, results='markup', warning=FALSE}
liefer %>%
  plot_ly(
    x = ~Lieferzeiten, 
    color=myPalette[2],
    stroke = I("black"),  width=400, height=400
  ) %>%
  layout(title="Der Datensatz Lieferzeiten")
```

# Hinzufügen eines Layers zu einer Abbildung

```{r liefer6, message=FALSE, results='markup', warning=FALSE}
liefer %>%
  count(Lieferzeiten) %>%
  plot_ly(width=400, height=400) %>%
  add_bars(
    x = ~Lieferzeiten, y = ~n,
    color=myPalette[2], stroke = I("black")
  ) 
```

Im Gegensatz zu *ggplot* führt die Funktion *add_bars* keine statistische Funktion
durch, wir müssen die Häufigkeiten vorher mit *count* in der Pipeline
berechnen.

# Der Datensatz *Körpergröße von Frauen*

```{r FrauenBars, message=FALSE, results='markup', warning=FALSE}
frauen %>%
  count(Koerpergroesse) %>%
  plot_ly(width=500, height=400) %>%
  add_bars(
    x = ~Koerpergroesse, y = ~n,
    color=myPalette[3], stroke = I("black")
  ) %>%
  layout(title="Absolute Häufigkeiten der Körpergröße von Frauen")
```

# Histogramme mit plotly

```{r FrauenHisto, message=FALSE, results='markup', warning=FALSE}
frauen %>%
  plot_ly(width=500, height=400) %>%
  add_histogram(
    x = ~Koerpergroesse,
    color=myPalette[3],
    stroke = I("black"),
  ) %>%
  layout(title="Absolute Häufigkeiten der Körpergröße von Frauen")
```

*ploty* verwendet eine Default-Einteilung in Klassen. Wenn wir eigene Intervalle
verwenden möchten setzen wir die Funktion *hist* ein und übergeben das Ergebnis
an *plot_ly*.

# Alternative Klassen für ein Histogramm

```{r FrauenHisto2, message=FALSE, results='markup', warning=FALSE}
h <- hist(frauen$Koerpergroesse, breaks="FD", plot=FALSE)

plot_ly(x = h$mids, y = h$counts, width=400, height=400) %>%
  add_bars(
    name = "FD",
    color=myPalette[3],
    stroke = I("black"),
  ) %>%
  layout(title="Klassenbreiten nach Freedman-Diaconis")
```

# Box-Plots

```{r box, message=FALSE, results='markup', warning=FALSE}  
liefer %>%
  plot_ly(width=400, height=400) %>%
  add_boxplot(
    y = ~Lieferzeiten,
    color=I("lightgreen"), stroke = I("black"), name="Lieferzeiten"
  ) %>%
  layout(
    title="Box-Plot für den Datensatz Lieferzeiten"
  )
```

# Vertikaler Box-Plot

```{r boxVert, message=FALSE, results='markup', warning=FALSE}
liefer %>%
  plot_ly(width=400, height=400) %>%
  add_boxplot(
    x = ~Lieferzeiten,
    color=I("lightgreen"), stroke = I("black"), name="Lieferzeiten"
  ) %>%
  layout(
    title="Box-Plot für den Datensatz Lieferzeiten"
  )
```




# Streuungsdiagramme

```{r scatter, echo=TRUE, results='markup', warning=FALSE}
wassergehalt %>% 
  plot_ly(width=600, height=400,
          x = ~Luftfeuchtigkeit, 
          y = ~Wassergehalt,
          color = myPalette[2], 
          mode="markers", 
          type="scatter"
       ) %>%
  layout(title="Streuungsdiagramm für den Datensatz Luftfeuchtigkeit")
```

# Weitere Einstellungen für Streuungsdiagramme

```{r scatter2, echo=TRUE, results='markup', warning=FALSE}
mpg %>%
  plot_ly(x = ~cty, y = ~hwy,
          width=600, height=400) %>%
  add_markers(color = ~factor(cyl), 
              showlegend = TRUE) %>%
  layout(title= "<b> Streuungsdiagramm für den Datensatz mpg</b>", 
         xaxis = list(title = "Verbrauch in der Stadt"),
         yaxis = list(title = "Verbrauch auf dem Highway"),
         legend = list(title=list(text='Anzahl Zylinder '))
         )
```

# Dreidimensionale Streuungsdiagramme

Bei 3D-Darstellungen ist *plotly* in der Lage ohne Mehraufwand interaktive
Darstellungen zu erzeugen. Wieder verwenden wir den Datensatz *mpg*
und weisen den drei Achsen, vollkommen analog zum zweidimensionalen Fall,
die Spalten hinzu. Statt wie im letzten Beispiel ein Merkmal für die
Farben einzusetzen verwenden wir *cyl* als z-Koordinate.


```{r scatter3d, echo=TRUE, results='markup', warning=FALSE}
legendtitle <- list(x=1.1, y=1.05, 
                    text="Anzahl der Zylinder",
                    showarrow=FALSE)
fig <- plot_ly(mpg, x = ~cty, y = ~hwy, z = ~cyl,
               width=900, height=600) %>%
       add_markers(color= ~factor(cyl),
                   showlegend = TRUE) %>%
       layout(title= "<b>3D Scatter Plot für den Datensatz mpg</b>", annotations=legendtitle,
              scene = list(
                xaxis = list(title = "Verbrauch in der Stadt"),
                yaxis = list(title = "Verbrauch auf dem Highway"),
                zaxis = list(title = "Zylinder")
              ))
```

# 3D Scatter Plot

```{r scatter3dbild, echo=FALSE, results='markup', warning=FALSE}
fig
```

# Literaturverzeichnis
