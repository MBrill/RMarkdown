---
title: "Analysis of Variance - ANOVA"
author: "Manfred Brill"
date: "Sommersemester 2021"
output: 
  html_document: 
    
    fig_caption: yes
    highlight: pygments
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float: yes  
  html_notebook:
    highlight: pygments
    number_sections: yes
    theme: cosmo
    toc: yes
    encoding: utf-8
bibliography: literatur.bib 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(knitr)
library(kableExtra)
suppressPackageStartupMessages(library(dplyr))
library(tidyverse)

# MASS für den Datensatz UScrime
library(MASS)

# Die ersten 4 Default-Farben aus ggplot2
library(scales)
defColors <- hue_pal()(4)

library(RColorBrewer)
myPalette <- brewer.pal(5, "RdYlGn")

# Library für die Funktion plotmeans
library(gplots)

suppressPackageStartupMessages(library(multcomp))
library(multcomp)

suppressPackageStartupMessages(library(car))
library(car)

# Ausgabe von double-Werte mit  zwei Stellen hinter dem Komma
options(digits=4)
```

# Motivation

Je nach Versuchsplanung erhalten wir Ergebnisse für die verschiedenen Levels
und responses. Dafür führen wir Hypothesentests durch. Bei einem completely randomized design mit nur 2 Stufen können wir hier die bereits betrachteten t-Tests verwenden, was wir als Einstieg in diesem Dokument nochmals tun werden.

Lieben mehr als 2 Stufen vor führen wir eine Varianzanalyse oder analysis of variance durch, abgekürzt ANOVA. 

# Completely randomized design
Das Beispiel das wir betrachten stamm aus [@mcclave_91] und wurde auch für die Abbildungen in den Folien verwendet. 

Zuerst verwenden wir die Daten, die zu einer Abbildung
gehören bei denen die Samples durcheinander gemischt sind.
Die arithmetischen Mittel sind zwar unterschiedlich, aber man
fragt sich schon ob die Nullhypothese wirklich verworfen wird.
Wir führen den Test durch:

```{r satscore1, include=TRUE, echo=TRUE, fig.height=2}
satscorefemale1 <- c(490, 520, 550, 580, 610)
satscoremale1 <- c(530, 560, 590, 620, 650)

scores1 <- c(490, 520, 550, 580, 610, 530, 560, 590, 620, 650)
satlevels <- as.factor(c("w", "w", "w", "w", "w",
                          "m", "m", "m", "m", "m"))

satscores1 <- tibble(response=scores1,
                     treatment=satlevels)


ggplot(satscores1, aes(x=response)) +
  geom_point(aes(y=0, color=treatment), size=3) + 
  geom_point(x=550, y=0, fill=defColors[3], size=4, shape=22) + 
  geom_point(x=590, y=0, fill=defColors[1], size=4, shape=22) +
  geom_text(x=550, y=-0.05, label="Mittelwert Frauen", 
            color=defColors[3], hjust="center") +
    geom_text(x=590, y=0.05, label="Mittelwert Männer", 
              color=defColors[1], hjust="center") +
    scale_y_continuous(limits=c(-0.1, 0.1)) +
  labs(
    title="Prüfungsergebnisse und Mittelwerte nach Geschlecht der Studierenden", 
    x="Erreichte Punktzahlen"
  ) +  
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank()) +
  guides(color=guide_legend(title="Geschlecht"))

```

```{r satscore1a, include=TRUE, echo=TRUE}
plotmeans(response ~ treatment, data=satscores1,
          xlab="Geschlecht",
          ylab='Prüfungsergebnisse',
          col="darkgoldenrod2",
          n.label=FALSE,
          use.t=TRUE,
          barwidth=2,
          barcol="darkgoldenrod1",
          main='Prüfungsergebnisse aus McClave-Benson (Fall 1)\n95% Konfidenzniveau')
          
t.test(response~treatment, data=satscores1,
                 paired=FALSE,
                 alternative="two.sided",
                 var.equal=FALSE)

aovfit <- aov(response~treatment, data=satscores1)

summary(aovfit)
```

Auf Grund dieser Ergebnisse verwerfen wir für diese Daten
die Nullhypothese, dass die Erwartungswerte bei Frauen und Männer gleich sind, nicht.

Jetzt verwenden wir die Daten, die zu einem Bild führen in denen die Samples der SAT-Scores visuell sehr gut getrennt sind.

```{r satscore2, include=TRUE, echo=TRUE, fig.height=2}
scores2 <- c(540, 545, 550, 555, 560, 580, 585, 590, 595, 600)

satscores2 <- tibble(response=scores2,
                     treatment=satlevels)


ggplot(satscores2, aes(x=response)) +
  geom_point(aes(y=0, color=treatment), size=3) + 
  geom_point(x=550, y=0, fill=defColors[3], size=4, shape=22) + 
  geom_point(x=590, y=0, fill=defColors[1], size=4, shape=22) +
  geom_text(x=550, y=-0.05, label="Mittelwert Frauen", 
            color=defColors[3], hjust="center") +
    geom_text(x=590, y=0.05, label="Mittelwert Männer", 
              color=defColors[1], hjust="center") +
    scale_y_continuous(limits=c(-0.1, 0.1)) +
  labs(
    title="Prüfungsergebnisse und Mittelwerte nach Geschlecht der Studierenden", 
    x="Erreichte Punktzahlen"
  ) +  
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(), 
        axis.ticks.y=element_blank()) +
  guides(color=guide_legend(title="Geschlecht"))
```

```{r satscore2a, include=TRUE, echo=TRUE}
plotmeans(response ~ treatment, data=satscores2,
          xlab="Geschlecht",
          ylab='Prüfungsergebnisse',
          col="darkgoldenrod2",
          n.label=FALSE,
          use.t=TRUE,
          barwidth=2,
          barcol="darkgoldenrod1",
          main='Prüfungsergebnisse aus McClave-Benson (Fall 2)\n95% Konfidenzniveau')

t.test(response~treatment, data=satscores2,
                 paired=FALSE,
                 alternative="two.sided",
                 var.equal=FALSE)

aovfit <- aov(response~treatment, data=satscores2)

summary(aovfit)
```

Auf Grund der Ausgaben der Funktion *t.test* verwerfen wir
die Nullhypothese und nehmen die Gegenhypothese an, dass sich
die Erwartungswerte der SAT-Scores für Frauen und Männer 
unterscheiden.

# One-way anova
Jetzt verwenden wir das Material aus [@kabacoff_15]. Wir gehen
hier davon aus, dass die Varianzen in beiden Gruppen gleich sind.

```{r kabacoff1, include=TRUE, echo=TRUE}
table(cholesterol$trt)

cholesterol %>%
  group_by(trt) %>%
  summarize(Mittelwerte=mean(response),
            Standardabweichungen=sd(response))

plotmeans(response ~ trt, data=cholesterol,
          xlab='Treatment', 
          ylab='Respose',
          main='Mittelwerte\n95% CI')
          
fit <- aov(response ~ trt, data=cholesterol)

summary(fit)
```

Aus den Ausgaben der Funktion *aov* und auch an Handj der grafischeh Ausgabe auf der Basis der Funktion *plotmeans* entscheiden wir uns dafür, die Nullhypothese, dass alle Faktoren den gleichen Erwartungswert besitzen zu verwerfen.

Jetzt stellt sich sofort die Frage, welche Level sich von welchem unterscheiden.
Auch dafür gibt es Funktionen in R, die uns darauf eine Antwort geben.

```{r kabacoff2, include=TRUE, echo=TRUE}
TukeyHSD(fit)

par(las=2)
par(mar=c(5,8,2,4))
plot(TukeyHSD(fit))

par(mar=c(5, 4, 6, 2))
tuk <- glht(fit, linfct=mcp(trt="Tukey"))
plot(cld(tuk, level=0.05), col="lightgrey")
```

Spätestens mit dem Boxplot, den wir mit Hilfe von glht erzeugen sehen wir, dass die Kontrollgruppe mit drugE am Besten abschneidet. Die Bedeutung der Buchstaben oberhalb der Boxplots findet man in Kabacoff auf SEite 221.

In der Annahme für die Verwendung der Funktion *aov* steckt auch,
dass die untersuchte Größe normalverteilt ist und die Varianzen
in den Faktoren gleich sind. Das können wir mit Hilfe eines Q-Q Plots
überprüfen.


```{r kabacoff3, include=TRUE, echo=TRUE}
qqPlot(lm(response~trt, data=cholesterol),
       simulate=TRUE,
       main="Q-Q Plot",
       labels=FALSE)
```

Die Punkte, die zu den Samples gehören fallen in das angezeigte 95%-Konfidenzintervall,
also gehen wir davon aus, dass die Annahme der Normalverteilung gegeben ist.

Alternativ können wir einen sogenannte Bartlett-Test durchführen:
Die Nullhypothese für diesen Hypothesentest ist, dass sich die 
Varianzen in den fünf Gruppen nicht stark unterscheiden.

```{r kabacoff4, include=TRUE, echo=TRUE}
bartlett.test(response~trt, data=cholesterol)
```

Wir erhalten eine Wahrscheinlichkeit von 1, dass sich die Varianzen
nicht unterscheiden, also verwerfen wir die Nullhypothese nicht.

# Literaturverzeichnis

