---
title: "Interaktive Dokumente und Anwendungen mit htmlwidgets"
author: "Manfred Brill"
output: 
  html_notebook:
    highlight: pygments
    number_sections: yes
    theme: cosmo
    toc: yes
    encoding: utf-8   
  html_document: 
    fig_caption: yes
    theme: cosmo
    highlight: pygments
    number_sections: yes
    toc: yes
    toc_float: yes
encoding: utf-8
---

```{r setup, include = FALSE}
library(dplyr)
suppressPackageStartupMessages(library(dplyr))
library(ggplot2)
library(plotly)
library(dygraphs)
suppressPackageStartupMessages(library(dygraphs))
library(DT)
suppressPackageStartupMessages(library(DT))
library(leaflet)
suppressPackageStartupMessages(library(leaflet))
library(visNetwork)
suppressPackageStartupMessages(library(visNetwork))

# Aspect Ratio und anderes für Abbildungen
knitr::opts_chunk$set(fig.width = 5, fig.asp = 1/3)
```

# Verwendete Packages
Für die verwendung dieses Notebooks benötigen Sie die folgenden installatierten Packages:

- tidyverse
- plotly
- dygraph
- DT
- leaflet
- visNetwork

Als Daten werden *diamonds* und *nh* verwendet. Die Daten über die Diamanten sind inn *tidyverse* enthalten,
*nh* ist in der Default-Installation enthalten.

# Interaktive Grafiken mit plotly
Grafiken, die wir mit *plotly* erstellen sind interaktiv. Dabei können wir direkt
*plotly* verwenden, oder eine Visualisierung mit ggplot2 erzeugen und anschließend
*ggplotly* verwenden, wie es auch im Beispiel hier gemacht wurde.

Wir erzeugen ein Histogramm mit *ggplot* und verwenden anschließend *ggplotly*:

```{r schliff, message=TRUE, warning=TRUE}
schliff <- ggplot(diamonds, aes(cut)) + 
  geom_bar( fill="orange", color="black") +
  labs(
    title = "Das Merkmal Schliff",
    x = "Schliff",
    y = ""
  )
ggplotly(schliff)
```

Wenn Sie mit der Maus über die Grafik gehen erhalten Sie ein Menu, in dem Sie zoomen und die Grafik auch abspeichern können.

# Zeitreihen mit Dygraphs
Daten, die von Zeitpunkten abhängen, sogenannte *Zeitreihen*, treten sehr häufig in den Datensätzen auf. Denken Sie an den Verlauf von Temperaturen oder Börsenkursen.

Die Visualierung solcher Daten ist in der Regel durch einen Polygonzug gegeben, auf der
horizontalen Achse wird die Zeit gelegt. 
Mit *dygraphs* können wir mit solchen
Darstellungen interagieren und das dargestellte Zeit-Intervall verändern. Als Daten verwenden wir hier *nhtemp*, Temperaturen 
in New Haven. Dieser Datensatz ist ein R verfügbar ohne dass wir ein weiteres Package laden müssen.

```{r timeseries, echo=TRUE}
dygraph(nhtemp, main = "Temperaturen in New Haven (nhtemp)") %>% 
  dyRangeSelector(
    dateWindow = c("1920-01-01", "1960-01-01"))
```

# Interaktive Tabellen mit DT
Auch wenn wir häufig grafische Darstellungen unserer Datensätze erstellen macht es Sinn Tabellen in einem Dokument oder in einem Dashboard einzubauen. Dazu gibt es das Package *DT*,
mit dem wir interaktive Tabellen erhalten.

Wir erstellen eine TAbelle von Diamanten, die wir absteigend nach den Karat-Angaben anordnen. In der Pipeline
legen wir fest welche Spalten wir in der Tabelle 
anzeigen möchten. Die Funktion *datatable* erzeugt
abschließend die interaktive Tabelle.

```{r tabelle}
diamonds %>% 
  arrange(desc(carat)) %>% 
  head(50) %>% 
  select(carat, cut, color, price) %>% 
  datatable()
```

# Karten mit Leaflet
Georeferenzierte Daten möchten wir natürlich mit Hilfe von Karten, zum Beispiel aus OpenStreetMap, visualisieren. Dazu gibt es *Leaflet*.

Wir setzen die Geo-Koordinaten des Zentrums unserer Karte,
die Zoom-Stufe und fügen als letzten Schritt Marker
hinzu.

```{r leaflet}
leaflet() %>%
  setView(7.36, 49.262 , zoom = 15) %>% 
  addTiles() %>%
  addMarkers(7.3611, 49.262, 
             popup = "Campus Zweibrücken") 
```

# Visualisierung von Graphen mit visNetwork
Graphen und Bäume sind Datenstrukturen, die wir häufig verwenden und natürlich auch
visualisieren möchten. Graph-Visualisierung ist nicht einfach, denn die mathematische Definition
eines Graphen enthält keinerlei Informationen über das Layout des Graphen. 
Dazu gibt es verschiedene Packages, auch ggplot2 enthält Funktionen für die Visualisierung
von Graphen. Mit *visNetwork* erhalten wir eine Darstellung, mit der wir interagieren können und in der wir insbesondere das Layout verändern können.

Sie sollten das Problem des Layouts für einen gegebenen Graphen nicht unterschätzen, dies ist immer noch ein Thema in der Forschung, insbesondere für sehr große Graphen.
Das Layout in *visNetwork* wird wie auch in anderen Lösungen mit Hilfe von Zufallszahlen beeinflusst,.
Um zu garantieren, dass wir bei diesem Notebook
immer das gleiche Layout erhalten verwneden wir
einen seed value für den Zufallszahlengenerator zu verwenden. 

Als Beispiel für einen Graphen besetzen wir Felder
mit den Knoten und Kanten und übergeben diese dann
an den Layouter. Das Verhalten im Ergebnis können wir mit
Funktionen aus dem Package einstellen und rufen als letzten Schritt in der Pipeline den Layouter auf.

```{r network, message=FALSE, warning=FALSE, results='markup'}
nodes <- data.frame(id = 1:5,
                    shape = c("dot"),
                    size = 5,
                    title = paste0("<b>Knoten ", 0:4,"</b>"),
                    color = c("green"))

edges <- data.frame(from = c(1, 1, 1, 3, 3, 4), 
                    to = c(2, 3, 5, 4, 5, 5),
                    title = paste0("Kante ", 1:6))

visNetwork(nodes, edges) %>%
    visOptions(highlightNearest = TRUE, 
              width = "100%") %>%
    visInteraction(dragNodes = TRUE, 
                   dragView = TRUE, 
                   zoomView = FALSE,
                   keyboard = TRUE,
                   navigationButtons = TRUE) %>%
    visLayout(randomSeed = 42)
```

Wir können auch gerichtete Graphen und Bäume, besser gesagt Hierarchien, darstellen.
Im folgenden Beispiel wird ein Baum dargestellt, den wir wie im letzten Beispiel mit entsprechenden Feld definieren.

```{r tree, message=TRUE, warning=TRUE, , results='markup'}
nodes <- data.frame(id = 0:7,
                    level = c(1, 2, 2, 3, 3, 3, 3, 3),
                    label = LETTERS[1:8],
                    title = paste0(0:7),
                    shape = c("circle"),
                    size = 5,
                    title = paste0("<b>", 0:7,"</b>"),
                    color = c("lightblue"))

edges <- data.frame(from = c(0, 0, 1, 1, 1, 2, 2), 
                    to = c(1, 2, 3, 4, 5, 6, 7),
                    width = 4,
                    color = c("green"))

visNetwork(nodes, edges, 
           height = "500px", 
           width = "100%") %>%
    visEdges(arrows = "to") %>%
    visNodes(shadow=TRUE) %>%
    visInteraction(dragNodes = FALSE, 
                   dragView = TRUE, 
                   zoomView = FALSE,
                   keyboard = TRUE,
                   navigationButtons = FALSE) %>%
  visHierarchicalLayout(levelSeparation = 250)
```
